# iOS 登山向けインカムアプリ 仕様書 v1.0

## 0. 概要

登山（近距離～中距離）での利用を想定し、**音楽を聴きながら気軽に会話できる**インカム体験を提供する。
基本は **サーバーを立てずにP2P中心**で動作し、近距離は **MultipeerConnectivity（以下MC）**、接続断時は **キャリア/インターネット経由（GameKit real-time、以下GK）**へ移行する。
グループは2〜6名。参加者は一度登録したら記憶し、起動時にグループ選択または新規作成・追加ができる。

---

## 1. 用語

* **Local**：MCを用いた近距離P2P通信（Bluetooth/Wi-Fi Direct等）
* **Internet**：GK real-timeを用いたインターネット経由通信（キャリア/Wi-Fi）
* **Group**：同時通話する固定最大6名の集合
* **Owner**：グループ内の暗黙的管理者（最小ID）。不在時は次点が自動繰上げ
* **VAD**：Voice Activity Detection（発話検出）。無音時は送信抑制
* **Handover**：Local⇄Internet の経路切替

---

## 2. 前提・制約

### 2.1 対象OS/技術

* [C-OS-001] **iOS 26以降のみ**対応
* [C-UI-001] UIは **SwiftUI**（最新OS前提のAPI利用可）
* [C-SRV-001] **自前の常設サーバーは立てない**

  * 例外として、Apple提供基盤（GameKit / APNsペイロード等）に必要最小限の情報を載せることは許容

### 2.2 利用環境想定

* [C-NET-001] 山岳では **圏外/不安定**が多い

  * 近距離は圏外でも成立する設計（Localが主）
  * Internetは「繋がるなら使う」「切れたら戻る/移行する」

---

## 3. ゴール / 非ゴール

### 3.1 ゴール

* [G-001] 音楽再生を継続したまま、**ハンズフリーの同時通話**を提供
* [G-002] 近距離は **Localで圏外でも通話可能**
* [G-003] Local切断時に **Internetへ移行**し通話を継続（可能な場合）
* [G-004] 2〜6名でのグループ通話と、相手・グループの永続化

### 3.2 非ゴール

* [NG-001] 常設サーバーによるアカウント管理・フレンド管理
* [NG-002] 無制限人数の会議品質（最大6固定）
* [NG-003] 高距離・基地局跨ぎを保証するSLA（圏外は圏外として扱う）

---

# 4. 要求（Requirements）

以降、**要求ID（R-xxx）**を仕様（S-xxx）と受け入れ条件（A-xxx）で対応させる。

## 4.1 機能要求

* [R-F-001] 音楽を聴きながら通話できる
* [R-F-002] 2〜6名の同時通話
* [R-F-003] 近距離はMCによるP2P（圏外想定）
* [R-F-004] Local接続が切れたらInternetへ移行（キャリア/Wi-Fiが使える場合）
* [R-F-005] Internet→Localへの**自動復帰**（将来、安定確認の導入余地を残す）
* [R-F-006] 一度登録した相手は覚える。起動時にグループ選択 or 新規作成
* [R-F-007] グループに過去接続した人/新規接続した人を追加できる
* [R-F-008] 同時に接続できるのは**同じグループのみ**
* [R-F-009] 招待はAirDrop、ダメならQRやIntentメッセージ送信
* [R-F-010] PTTボタン等が押せない場合を考慮し、**同時通話（常時開通に近い体験）**が必要
* [R-F-011] ただし送信は **VADで抑制**（電池・帯域最適化）
* [R-F-012] 管理上の問題がある場合、暗黙的オーナー導入OK

  * 最小IDがオーナー、見失ったら次点がオーナー

## 4.2 非機能要求

* [R-NF-001] 低遅延（会話可能な体感）を優先
* [R-NF-002] バッテリー効率（無音時送信抑制、低頻度維持）
* [R-NF-003] セキュリティ（第三者がグループに混入しない）
* [R-NF-004] AIが読みやすく、人間レビューもできるドキュメント構造

---

# 5. 仕様（Specifications）

## 5.1 アーキテクチャ（トランスポート二層）

* [S-ARCH-001] 通信は Transport 抽象化を行い、**同一APIで Local / Internet を切替**

  * `Transport.connect(group)`
  * `Transport.disconnect()`
  * `Transport.sendAudioFrame(frame)`
  * `Transport.sendControl(msg)`
  * `Transport.onEvent`（peer join/leave, link metrics 等）

* [S-ARCH-002] LocalTransport は **MultipeerConnectivity**

  * 送信は基本 `unreliable`（遅延優先）

* [S-ARCH-003] InternetTransport は **GameKit real-time（GKMatch）**

  * NAT越え等はApple基盤に委任（自前サーバー不要）

## 5.2 グループモデル・永続化

* [S-GRP-001] グループは最大6名固定、グループIDはUUID
* [S-GRP-002] 永続化

  * 機密（GroupSecret / 鍵/セッション鍵）は Keychain
  * 表示情報（グループ名、メンバー表示名等）はローカルDB（例：SwiftData）
* [S-GRP-003] 起動時に「最近のグループ」一覧を提示し、選択して接続開始
* [S-GRP-004] 新規グループ作成時、過去接続メンバーと新規メンバーを追加可能

## 5.3 同一グループのみ接続（フィルタリング）

* [S-GRP-010] GroupSecretから `groupHash = H(GroupID + GroupSecret)` を生成し識別に用いる
* [S-GRP-011] Local（MC）広告/探索時に groupHash を含め、**他グループを見えない/接続不可**にする
* [S-GRP-012] 接続確立後も control handshake で groupHash を検証し不一致なら即切断

## 5.4 招待（AirDrop / QR / メッセージ）

* [S-INV-001] 招待は「グループ参加トークン」を配布する
* [S-INV-002] 招待トークン内容（最小）

  * `GroupID`
  * `GroupSecret`（共有シークレット）
  * `InviterMemberID`
  * `Signature`（改ざん防止、Inviterの鍵で署名）
  * 任意：表示名、作成時刻、期限
* [S-INV-003] 配布チャネル

  * AirDrop：JSON or URL（アプリで受け取れる形式）
  * QR：URL化してQR生成
  * メッセージ：Intent/共有シートでURL送信

## 5.5 オーナー選出（暗黙的）

* [S-OWN-001] 各端末は鍵ペアを生成し、`MemberID = trunc(SHA256(publicKey))`
* [S-OWN-002] **辞書順最小のMemberIDがOwner**
* [S-OWN-003] Owner不在（切断・消失）を検知したら、残存メンバーで再選出（次点がOwner）
* [S-OWN-004] Ownerの責務は「最低限の調停」に限定（単一障害点にしない）

  * 例：メンバー一覧の正規化、設定値の最終決定、安定確認の判定者 など

## 5.6 音声（音楽＋同時通話）

* [S-AUD-001] `AVAudioSession` は `playAndRecord` を利用し、音楽と同時再生を可能にする

  * option例：`mixWithOthers`, `allowBluetooth`, `allowBluetoothA2DP`
  * mode例：`voiceChat`
* [S-AUD-002] 通話は「各端末が自分の音声を送信し、受信音声をミックスして再生」
* [S-AUD-003] コーデックは低遅延・耐損失を優先（例：Opus想定）
* [S-AUD-004] 受信側に小さなジッタバッファ（20〜60ms程度）を持ち、期限超過フレームは破棄

## 5.7 VADによる送信抑制（合意済み）

* [S-VAD-001] 無音時は VOICE フレーム送信を停止（電池/帯域削減）
* [S-VAD-002] ただし無音時も **KEEPALIVE** を低頻度送信し、接続維持と品質測定を行う
* [S-VAD-003] VAD状態機械（最小）

  * `Idle` → `Attack` → `Talking` → `Release` → `Idle`
  * `Attack`: 40–60ms / `Release(Hangover)`: 200–400ms（体感の途切れ防止）
* [S-VAD-004] “話し始めの頭欠け”防止として **プレロール**（例：直近200ms）を保持し送信開始時に吐く

## 5.8 Handover（Local→Internet / Internet→Local 自動復帰）

* [S-HO-001] Local接続断（または品質悪化で断見込み）時に Internet を起動し接続を試みる
* [S-HO-002] Internet→Local復帰は**自動**

  * ただし将来の安定確認に備え、以下のフェーズを持つ

    * `InternetConnected`
    * `LocalCandidate`（同グループのLocalを検出）
    * `LocalProbing`（品質測定ウィンドウ：例 5–10秒）
    * `HandoverToLocal`（短時間の二重送信 0.5–1.5秒）
    * `LocalConnected`
* [S-HO-003] Probingの測定指標（軽量）

  * RTT（ping/pong）
  * packet loss（seq欠番率）
  * jitter（到着間隔ばらつき）
  * peer count（一致/必要数）
* [S-HO-004] Handover中は二重送信可。受信側は `streamID + seq` で重複排除し、先着採用

## 5.9 セキュリティ

* [S-SEC-001] グループ参加は GroupSecret を持つ者のみ（招待トークンで配布）
* [S-SEC-002] 接続時ハンドシェイクで相互認証（署名/MAC）
* [S-SEC-003] 音声パケットはセッション鍵で暗号化（CryptoKit対称鍵想定）
* [S-SEC-004] 受信側はグループ不一致・署名不正は破棄し、必要なら切断

## 5.10 UI（最大6固定）

* [S-UI-001] 通話画面は最大6枠の固定カード（名前、接続状態、話中、ミュート）
* [S-UI-002] 起動導線：グループ選択 → 接続 → 通話画面
* [S-UI-003] 招待導線：グループ画面から AirDrop / QR / 共有 を選択

---

# 6. 受け入れ条件（Acceptance Criteria）

要求IDごとに「満たしたと判断できる条件」を定義する。

## 6.1 音楽＋通話

* [A-F-001] 音楽再生中に通話を開始しても、音楽が停止しない（ユーザー操作で停止しない限り継続）
* [A-F-002] イヤホン（有線/BT）利用時に通話音声が聞こえ、マイク入力が取得できる

## 6.2 グループ通話（2〜6）

* [A-F-003] 2名で双方向に会話できる
* [A-F-004] 6名まで参加でき、同時発話が重なっても音が出続ける（多少の劣化は許容）
* [A-F-005] 参加/退出がUIに反映される（最大6枠）

## 6.3 近距離（Local/MC）

* [A-F-006] 圏外状態（機内モード＋Wi-Fi/BT等の条件で可能な範囲）で、近距離端末同士が接続できる
* [A-F-007] Localでは音声フレーム送信が `unreliable` で行われ、遅延が過度に増えない

## 6.4 断→Internet移行（GK）

* [A-F-008] Localを意図的に切断（距離/設定）したとき、Internetが利用可能なら自動で通話が復帰する
* [A-F-009] Internetが利用不可なら「再接続試行中/圏外」等の状態がUIで分かる

## 6.5 Internet→Local 自動復帰（将来の安定確認余地込み）

* [A-F-010] Internet中にLocal候補が現れたら自動復帰を試みる
* [A-F-011] Probingフェーズを設けられる構造になっている（メトリクス取得・判定が差し替え可能）
* [A-F-012] 復帰時に音声が完全無音になる時間が最小化されている（二重送信/重複排除が機能）

## 6.6 VAD送信抑制

* [A-F-013] 無音状態でVOiCE送信が止まり、発話すると遅延少なく再開する
* [A-F-014] 話し始めの頭が極端に欠けない（プレロールが効いている）
* [A-F-015] 無音時も接続が維持されやすい（KEEPALIVEが一定周期で送信される）

## 6.7 相手・グループ記憶

* [A-F-016] 一度参加したメンバーが履歴に残り、次回起動時に同じグループへ再接続できる
* [A-F-017] 新規グループ作成時に、過去メンバー＋新規メンバーを追加できる

## 6.8 同一グループのみ接続

* [A-F-018] 別グループの端末は探索/接続対象に現れない、または接続できない
* [A-F-019] 接続後にgroupHash不一致が判明した場合、音声が流れず切断される

## 6.9 招待

* [A-F-020] AirDropで招待トークンを受け取り、参加できる
* [A-F-021] QRで招待トークンを読み取り、参加できる
* [A-F-022] メッセージ共有（Intent/共有シート）経由で参加できる

## 6.10 オーナー

* [A-F-023] MemberIDの最小がOwnerになり、Ownerが離脱したら次点がOwnerになる
* [A-F-024] Ownerがいなくてもグループが機能停止しない（再選出が動く）

## 6.11 セキュリティ

* [A-NF-001] GroupSecret無しでは参加できない
* [A-NF-002] 改ざん招待トークンは拒否される（署名検証）
* [A-NF-003] 受信側で不正パケット（署名/MAC不正）は破棄される

---

# 7. 実装順（フェーズ / MVPから段階的に）

「最小で体験が出る順」に、上記の要求・仕様を満たすよう分割する。

## Phase 1: Local 2人通話（体験の核）

* 実装対象

  * [S-ARCH-001][S-ARCH-002] Transport抽象＋MC実装
  * [S-AUD-001][S-AUD-002][S-AUD-004] オーディオ入出力＋ジッタ
  * [S-VAD-001][S-VAD-003][S-VAD-004] VAD＋プレロール
  * [S-VAD-002] KEEPALIVE（最低限）
* 受け入れ

  * [A-F-001][A-F-003][A-F-006][A-F-013][A-F-014][A-F-015]

## Phase 2: Local 6人通話（固定UI）

* 実装対象

  * [S-AUD-002] 受信ミックス
  * [S-UI-001] 最大6固定UI
  * join/leaveのUI反映
* 受け入れ

  * [A-F-004][A-F-005]

## Phase 3: グループ・履歴・同一グループ制約

* 実装対象

  * [S-GRP-001..004] グループ永続化・起動時選択
  * [S-GRP-010..012] groupHashでフィルタ＆検証
* 受け入れ

  * [A-F-016][A-F-017][A-F-018][A-F-019]

## Phase 4: 招待（AirDrop → QR → メッセージ）

* 実装対象

  * [S-INV-001..003] 招待トークン生成・受領・参加
* 受け入れ

  * [A-F-020][A-F-021][A-F-022]

## Phase 5: Internet移行（Local断→GK）

* 実装対象

  * [S-ARCH-003] GK Transport
  * [S-HO-001] Local断時にInternet起動
  * 重複排除のための frame metadata（streamID/seq）
* 受け入れ

  * [A-F-008][A-F-009]

## Phase 6: 自動復帰（Internet→Local）＋将来の安定確認の足場

* 実装対象

  * [S-HO-002] Candidate/Probing/Handoverフェーズ
  * [S-HO-003] RTT/loss/jitter/peer count の計測API
  * [S-HO-004] 二重送信＋重複排除
* 受け入れ

  * [A-F-010][A-F-011][A-F-012]

## Phase 7: セキュリティ強化（出荷品質）

* 実装対象

  * [S-SEC-001..004] 招待署名、相互認証、音声暗号化
  * [S-OWN-001..004] Owner選出・繰上げ
* 受け入れ

  * [A-F-023][A-F-024][A-NF-001..003]

---

# 8. 実装メモ（落とし穴回避）

* 無音時0送信は避け、KEEPALIVEを残す（切断・品質判定不能になりやすい）
* Handoverは「切替瞬間の音切れ」が最大のUX劣化点：二重送信＋重複排除を前提に設計
* “同一グループのみ”は探索段階のフィルタだけでなく、接続後の検証も必須
